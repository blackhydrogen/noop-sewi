<style>
	.image-resource-container {
		height: 400px;
		width: 1000px;
		position: relative;
		overflow: hidden;
	}
	.image-resource-image-container {
		width: 100%;
		height: 100%;
		background: #CCCCCC;
		overflow: hidden;
		position: relative;
	}
	.image-resource-image {
		position: absolute;
		height: auto;
	}
	.image-resource-control-panel {
		color: white;
		width: 100%;
		height: 50px;
		background-color: rgba(0, 0, 0, 0.8);
		position: absolute;
		bottom: 0px;
		left: 0px;
	}
	.image-resource-control-panel.hidden {
		bottom: -50px;
	}
	.image-resource-control {
		margin-right: 10px;
		float: left;
		text-align: center;
		height: 100%;
	}
	.image-resource-show-hide-button {
		position: absolute;
		bottom: 0px;
		right: 0px;
		width: 100px;
		opacity: 0.3;
	}
	.image-resource-zoom {
		width: 45px;
	}
	.image-resource-show-hide-button:hover {
		opacity: 1;
	}
	.animated {
  		transition: all 200ms ease-in-out 0s;
	}
</style>
<script src="http://code.jquery.com/jquery-2.1.1.min.js">
</script>
<script type="text/javascript">

var mainContainer = $("<div class='image-resource-container'></div>");
	var imageContainer = $("<div class='image-resource-image-container'></div>")
	.appendTo(mainContainer);
		var imageElement = $("<img src='sf.png' class='image-resource-image'>")
		.appendTo(imageContainer);
	var controlsContainer = $("<div class='image-resource-control-panel animated'></div>")
	.appendTo(mainContainer);
		var brightnessControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
		.html("Brightness<br>");
			var brightnessControl = $("<input type='range' class='image-resource-brightness' min='0' max='2' step='0.1'>")
			.appendTo(brightnessControlContainer);
		var contrastControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
		.html("Contrast<br>");
			var contrastControl = $("<input type='range' class='image-resource-contrast' min='0' max='2' step='0.1'>")
			.appendTo(contrastControlContainer);
		var invertControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
			var invertControlLabel = $("<label>Invert</label>")
			.appendTo(invertControlContainer);
				var invertControl = $("<input type='checkbox' class='image-resource-invert'>")
				.prependTo(invertControlLabel);
		var differenceControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
			var differenceControlLabel = $("<label>Difference</label>")
			.appendTo(differenceControlContainer);
				var differenceControl = $("<input type='checkbox' class='image-resource-difference'>")
				.prependTo(differenceControlLabel);
		var grayscaleControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
			var grayscaleControlLabel = $("<label>Grayscale</label>")
			.appendTo(grayscaleControlContainer);
				var grayscaleControl = $("<input type='checkbox' class='image-resource-grayscale'>")
				.prependTo(grayscaleControlLabel);
		var zoomControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer)
		.html("Zoom<br>");
			var zoomControl = $("<input type='number' class='image-resource-zoom' min='10' max='200' step='10'>")
			.appendTo(zoomControlContainer);
			$("<span>%</span>")
			.appendTo(zoomControlContainer)
			var zoom100PercentButton = $("<input type='button' class='image-resource-zoom-100' value='100%'>")
			.appendTo(zoomControlContainer);
			var zoomFitButton = $("<input type='button' class='image-resource-zoom-fit' value='Fit'>")
			.appendTo(zoomControlContainer);
		var resetControlContainer = $("<div class='image-resource-control'></div>")
		.appendTo(controlsContainer);
			var resetControl = $("<input type='button' value='Reset' class='image-resource-reset-button'>")
			.appendTo(resetControlContainer);
	var showHideControlsButton = $("<input type='button' value='Hide Controls' class='image-resource-show-hide-button'>")
	.appendTo(mainContainer);

var imageProperties = {
	original: {},
	fit: {},
	minZoom: {},
	maxZoom: {}
};

var imageMovementVariables = {
}

$(function() {

	mainContainer.prependTo( $("body") );

	brightnessControl.on("input", adjustImageFilters);
	contrastControl.on("input", adjustImageFilters);
	invertControl.on("change", adjustImageFilters);
	differenceControl.on("change", updateCustomFilters);
	grayscaleControl.on("change", updateCustomFilters);
	zoomControl.on("change", calculateImageZoomFromZoomControl);
	zoom100PercentButton.on("click", function() {
		executeZoomImage(imageProperties.original.width, imageContainer.width() / 2, imageContainer.height() / 2);
	});
	zoomFitButton.on("click", setImageZoomToFit);

	resetControl.on("click", function() {
		brightnessControl.val(1);
		contrastControl.val(1);
		invertControl.prop("checked", false);
		differenceControl.prop("checked", false);
		grayscaleControl.prop("checked", false);
		updateCustomFilters();
		adjustImageFilters();
		setImageZoomToFit();
	})

	showHideControlsButton.on("click", function() {
		if($(this).val() == "Hide Controls") {
			controlsContainer.addClass("hidden");
			$(this).val("Show Controls");
		}
		else {
			controlsContainer.removeClass("hidden");
			$(this).val("Hide Controls");	
		}
	});

	imageContainer.on("mousewheel", calculateImageZoomFromMousewheel);

	imageContainer.on("mousedown", function(event) {
		imageMovementVariables.originalCursorX = event.pageX;
		imageMovementVariables.originalCursorY = event.pageY;
		imageMovementVariables.originalImageX = imageElement.position().left;
		imageMovementVariables.originalImageY = imageElement.position().top;
		imageMovementVariables.maxImageX = imageContainer.width() / 2;
		imageMovementVariables.maxImageY = imageContainer.height() / 2;
		imageMovementVariables.minImageX = imageMovementVariables.maxImageX - imageElement.width();
		imageMovementVariables.minImageY = imageMovementVariables.maxImageY - imageElement.height();
		imageMovementVariables.ignoreEvent = false; // Used for performances purposes. This variable is set when moveImageToCursor is called too quickly consecutively (after each call to moveImageToCursor, it is set to true, then a timeout() - with some delay - is set it back to false)

		imageContainer.unbind("mousewheel", calculateImageZoomFromMousewheel); //Don't allow the user to move and zoom

		$("body").on("mousemove", moveImageToCursor);

		$("body").one("mouseup", function(event) {
			imageContainer.on("mousewheel", calculateImageZoomFromMousewheel);
			$("body").unbind("mousemove", moveImageToCursor);
		});
		
	});

	imageElement.one("load", function() {
		setImageProperties();
		setImageZoomToFit();
	});
	
});

function moveImageToCursor(event) {
	if(imageMovementVariables.ignoreEvent) return false;
	var newImageX =  imageMovementVariables.originalImageX + event.pageX - imageMovementVariables.originalCursorX;
	var newImageY =  imageMovementVariables.originalImageY + event.pageY - imageMovementVariables.originalCursorY;

	if(newImageX < imageMovementVariables.minImageX)
		newImageX = imageMovementVariables.minImageX;
	else if(newImageX > imageMovementVariables.maxImageX)
		newImageX = imageMovementVariables.maxImageX;

	if(newImageY < imageMovementVariables.minImageY)
		newImageY = imageMovementVariables.minImageY;
	else if(newImageY > imageMovementVariables.maxImageY)
		newImageY = imageMovementVariables.maxImageY;

	imageElement.css({
		top: newImageY,
		left: newImageX
	});

	imageMovementVariables.ignoreEvent = true;
	setTimeout(function() {
		imageMovementVariables.ignoreEvent = false;
	}, 10);

	return false;
}

function calculateImageZoomFromMousewheel(event) {
	//Figure out new width
	var zoomChange = 1 + 0.2 * event.originalEvent.wheelDelta / 120;
	var newImageWidth = imageElement.width() * zoomChange;

	executeZoomImage(newImageWidth, event.clientX, event.clientY);

	return false;
}

function executeZoomImage(newImageWidth, centreOnX, centreOnY) {
	if(newImageWidth < imageProperties.minZoom.width) {
		newImageWidth = imageProperties.minZoom.width;
	}
	else if(newImageWidth > imageProperties.maxZoom.width) {
		newImageWidth = imageProperties.maxZoom.width;
	}

	// Figure out where to centre image after resizing based on centreOnX, centreOnY

	// Where, in pixels, inside the image is the centre (relative to the image)
	var imageX = centreOnX - imageElement.position().left;
	var imageY = centreOnY - imageElement.position().top

	// TODO add condition, if imageX or imageY is out image coordinates, then centre on centre of imageContainer

	var imageRatioX = imageX / imageElement.width();
	var imageRatioY = imageY / imageElement.height();

	imageElement.width( newImageWidth );

	var newImageX = centreOnX - imageRatioX * imageElement.width();
	var newImageY = centreOnY - imageRatioY * imageElement.height();

	imageElement.css({
		top: newImageY,
		left: newImageX
	});

	zoomControl.val( Math.floor(imageElement.width() / imageProperties.original.width * 100) );
}

function calculateImageZoomFromZoomControl() {
	var newImageWidth = imageProperties.original.width * zoomControl.val() / 100;

	executeZoomImage(newImageWidth, imageContainer.width() / 2, imageContainer.height() / 2);
}

function setImageZoomToFit() {
	executeZoomImage(imageProperties.fit.width, 0, 0);
	centreImageOnCanvas();
}

function centreImageOnCanvas() {
	imageElement.css({
		top: (imageContainer.height() - imageElement.height()) / 2,
		left: (imageContainer.width() - imageElement.width()) / 2
	});
}

function setImageProperties() {
	imageProperties.original.width = imageElement.prop("naturalWidth");
	imageProperties.original.height = imageElement.prop("naturalHeight");
	imageProperties.original.url = imageElement.prop("src");

	//Compute fit sizes
	var originalWidth = imageElement.prop("naturalWidth");
	var originalHeight = imageElement.prop("naturalHeight");
	var containerWidth = imageContainer.width();
	var containerHeight = imageContainer.height();

	if(originalWidth <= containerWidth) {
		if(originalHeight <= containerHeight) {
			imageProperties.fit.width = originalWidth;
			imageProperties.fit.height = originalHeight;
		}
		else {
			imageProperties.fit.width = originalWidth * containerHeight / originalHeight;
			imageProperties.fit.height = containerHeight;
		}
	}
	else {
		if(originalHeight <= containerHeight) {
			imageProperties.fit.width = containerWidth;
			imageProperties.fit.height = originalHeight * containerWidth / originalWidth;
		}
		else {
			var adjustedWidth = originalWidth * containerHeight / originalHeight;

			if(adjustedWidth <= containerWidth) {
				imageProperties.fit.width = adjustedWidth;
				imageProperties.fit.height = originalHeight * adjustedWidth / originalWidth;
			}
			else {
				imageProperties.fit.width = containerWidth;
				imageProperties.fit.height = originalHeight * containerWidth / originalWidth;
			}
		}
	}
	// End Compute fit sizes

	imageProperties.minZoom.width = imageProperties.fit.width / 2;
	imageProperties.minZoom.height = imageProperties.fit.height / 2;

	imageProperties.maxZoom.width = imageProperties.original.width * 2;
	imageProperties.maxZoom.height = imageProperties.original.height * 2;
}

function updateCustomFilters() {
	if(differenceControl.prop("checked") == 1 || grayscaleControl.prop("checked") == 1) {
		canvasElement = $("<canvas></canvas>")
		.prop("width", imageProperties.original.width)
		.prop("height", imageProperties.original.height);

		var originalImage = $("<img>").prop("src", imageProperties.original.url);

		canvasElement[0].getContext("2d").drawImage(originalImage[0], 0, 0, imageProperties.original.width, imageProperties.original.height);

		var canvasData = canvasElement[0].getContext("2d").getImageData(0, 0, 1600, 1200);

		if(grayscaleControl.prop("checked") == 1) {
			for(var i = 0; i < canvasData.data.length; i += 4) {
				// Luminosity method: 0.21 R + 0.72 G + 0.07 B
				var newColor = Math.floor(0.21 * canvasData.data[i]) + Math.floor(0.72 * canvasData.data[i+1]) + Math.floor(0.07 * canvasData.data[i+2]);
				canvasData.data[i] = newColor;
				canvasData.data[i+1] = newColor;
				canvasData.data[i+2] = newColor;
			}
		}
		if(differenceControl.prop("checked") == 1) {
			for(var i = 0; i < canvasData.data.length; i += 4) {
				canvasData.data[i] = Math.abs(255 - 2 * canvasData.data[i]);
				canvasData.data[i+1] = Math.abs(255 - 2 * canvasData.data[i+1]);
				canvasData.data[i+2] = Math.abs(255 - 2 * canvasData.data[i+2]);
			}
		}

		canvasElement[0].getContext("2d").putImageData(canvasData, 0, 0);

		imageElement.prop("src", canvasElement[0].toDataURL("image/png"));
	}
	else {
		imageElement.prop("src", imageProperties.original.url);
	}
}

function adjustImageFilters() {
	imageElement.css("-webkit-filter",
			"brightness(" + brightnessControl.val() + ")"
			+ "contrast(" + contrastControl.val() + ")"
			+ "invert(" + (invertControl.prop("checked") ? 1 : 0) + ")");
}

</script>

<body>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
<p>hi</p>
</body>